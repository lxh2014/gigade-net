@{
    ViewBag.Title = "MarketTallyWD";
}

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes " />

<script src="../../Scripts/jquery-2.1.4.min.js"></script>
<link href="../../Scripts/Bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link href="../../Scripts/Bootstrap/css/bootstrap-table.min.css" rel="stylesheet" />
<script src="../../Scripts/Bootstrap/bootstrap.min.js"></script>
<script src="../../Scripts/Bootstrap/bootstrap-table.min.js"></script>

    <title></title>
</head>


<div class="container">
    <h1>提示：請輸入出貨單號!</h1>
    <br />
    <h3>工作代號： <span class="label label-info">@ViewBag.number</span></h3>
    <h3>產品條碼： <span class="label label-info">@ViewBag.upc</span></h3>


    <div>
        <h3 >訂單號：&nbsp&nbsp&nbsp <span class="label label-info" id="ord_id"></span></h3>
        <h3 >品名：&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp  <span class="label label-info " id="productname"></span></h3>
        <h3 >撿貨數量： <span class="label label-info " id="out_qty"></span></h3>
        <h3 >實際撿貨量統計： <span class="label label-success " id="act_pick_qty">0</span></h3>
        <h3 class="hidden">料位： <span class="label label-info " id="hidden_loc_id"/></h3>
        <h3 class="hidden">細項編號： <span class="label label-info " id="hidden_item_id"/></h3>
        <h3 class="hidden">出貨單號： <span class="label label-info " id="hidden_deliver_code"/></h3>
        <h3 class="hidden">訂單數量： <span class="label label-info " id="hidden_ord_qty"/></h3>
        <h3 class="hidden">訂單詳情編號： <span class="label label-info " id="hidden_ordd_id"/></h3>
        <h3 class="hidden">aseld表的流水號： <span class="label label-info " id="hidden_seld_id"/></h3>
        <br />  
        @*data-url="/MarketTally/GetStockByUpc?upc_id="+@ViewBag.upc data-toggle="table"class="hidden"*@
        <table class="table table-bordered table-striped table-hover" id="stock_table" >
            <thead class="lead">
                <tr>
                    <th data-field="row_id" data-halign="center" data-align="center" data-valign="middle"  data-visible="false">row_id
                    </th>
                    <th data-field="item_id" data-halign="center" data-align="center" data-valign="middle"  data-visible="false">item_id
                    </th>
                    <th data-field="cde_dt" data-halign="center" data-align="center" data-valign="middle" >有效日期
                    </th>
                    <th data-field="made_date" data-halign="center" data-align="center" data-valign="middle" >製造日期
                    </th>
                    <th data-field="prod_qty" data-halign="center" data-align="center" data-valign="middle" >庫存數量
                    </th>
                    <th data-field="vendor_id" data-halign="center" data-align="center" data-valign="middle"  data-visible="false">vendor_id
                    </th>
                    <th data-field="cde_dt_shp" data-halign="center" data-align="center"  data-valign="middle" data-visible="false">cde_dt_shp
                    </th>
                    <th data-field="pick_num" data-halign="center" data-align="center" data-valign="middle"  data-formatter="nameFormatter"  data-events="operateEvents">撿貨數量

                    </th>
                </tr>
            </thead>
            @*        <tbody>
        </tbody>*@
        </table>

        <br />
        <div class="row">
            <div class="col-lg-8">
                <div class="input-group " id="delivercode_group">
                    <span class="input-group-btn">
                        <button class="btn btn-default btn-lg " type="button">出貨單號</button>
                    </span>
                    <input type="text" class="form-control input-lg" id="delivercode" placeholder="請輸入出貨單號...">

                    <span class="glyphicon " id="inputGroupStatus_delivercode" aria-hidden="true"></span>
                </div>
                <!-- /input-group -->
            </div>
            <!-- /.col-lg-8 -->
        </div>
        <!-- /.row -->
        <br />
        <button class="btn btn-default btn-lg disabled " id="amsure" type="button">確認撿貨</button>
    </div>
</div>

<div class="modal fade MarketTally-modal-alert" role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title" >提示</h3>
      </div>
      <div class="modal-body">
        <div class="container-fluid">         
          <h4 id="MessageContentId" class="text-center">錯誤提示</h4>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" id="modal-dialog-close" data-dismiss="modal">關閉</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
    function nameFormatter(value, row, index)
    {
        return '<input type="number"  min="0" class="form-control" id="pick_num' + index + '"  placeholder="0">';
    }
    window.operateEvents = {
        'input .form-control': function (e, value, row, index)
        {
            
            var result = eval("(" + JSON.stringify($('#stock_table').bootstrapTable('getData')) + ")");
            var sum = 0;
            
            for(var i=0;i<result.length;i++)
            {
                // alert($('#pick_num0').val());
                //alert(i)
                //alert($('#pick_num' + i).val());
                if ($('#pick_num' + i).val() != "")
                {
                    sum = sum + parseInt($('#pick_num' + i).val());
                }
                if ($('#pick_num' + i).val()=="-")
                {
                    alert("-")
                }
            }

            $('#act_pick_qty').text(sum); 
            if (sum > parseInt($('#out_qty').text()))
            {
                $('#act_pick_qty').attr("class", "label label-danger");
                $('#MessageContentId').text("實際撿貨量不能大於撿貨數量!");
                $('.MarketTally-modal-alert').modal('toggle')
                $('#modal - dialog - close').focus();
                return false;
            }
            else
            {
                $('#act_pick_qty').attr("class", "label label-success");
            }

            if (parseInt(result[index].prod_qty) < parseInt($('#pick_num' + index).val()))
            {
                alert("該商品庫存不夠，確認直接進行商品數量庫調？");
                if (true)
                {
                    //alert($("#hidden_item_id").text());
                    //調整庫存；
                    var item_id = $("#hidden_item_id").text();
                    var order_id = $("#ord_id").text();
                    var loc_id = $("#hidden_loc_id").text();
                    var prod_qty = result[index].prod_qty;
                    var made_date = result[index].made_date;
                    var pnum = parseInt($('#pick_num' + index).val());

                    $.get('/MarketTally/RFKT', { item_id: item_id, order_id: order_id, loc_id: loc_id, prod_qty: prod_qty, made_date: made_date, pnum: pnum }, function (data)
                    {
                        var result = eval("(" + data + ")");
                        if (result.success)
                        {
                            if (result.msg == "100")
                            {
                            }
                            if (result.msg == "2")
                            {
                                $('#MessageContentId').text("今日的庫存已鎖，不能庫調");
                                $('.MarketTally-modal-alert').modal('toggle')
                                $('#modal - dialog - close').focus();
                            }
                        }
                        else
                        {
                            $('#MessageContentId').text("系統故障,內部庫調失敗!");
                            $('.MarketTally-modal-alert').modal('toggle')
                            $('#modal - dialog - close').focus();
                        }

                    }).error(function ()
                    {
                        $('#MessageContentId').text("系統故障,內部庫調失敗!");
                        $('.MarketTally-modal-alert').modal('toggle')
                        $('#modal - dialog - close').focus();
                    })
                }
                $('#stock_table').bootstrapTable('refresh');
                //return false;
            }
        }
    };
</script>

<script type="text/javascript">
    $(document).ready(function ()
    {
        //頁面加載時調用
        {
            {
                $("#delivercode").focus();
            }
            var upc = '@ViewBag.upc'
            var number='@ViewBag.number'
            $.get('/MarketTally/GetAseldByUpc', { assg_id: number, upc_id: upc }, function (data)
            {
                var result = eval("(" + data + ")");
                if (result.success)
                {
                    if (result.totalCount > 0)
                    {

                        var prod = "";
                        if (result.data[0].prod_sz != "")
                        {
                            prod = "(" + result.data[0].prod_sz + ")";
                        }

                        $("#ord_id").text(result.data[0].ord_id);
                        $("#productname").text(result.data[0].description + prod); 
                        $("#out_qty").text(result.data[0].out_qty);
                        $("#act_pick_qty").text(result.data[0].act_pick_qty);
                        
                        $("#hidden_loc_id").text(result.data[0].sel_loc);
                        $("#hidden_item_id").text(result.data[0].item_id);
                        $("#hidden_deliver_code").text(result.data[0].deliver_code);
                        $("#hidden_ord_qty").text(result.data[0].ord_qty);
                        $("#hidden_ordd_id").text(result.data[0].ordd_id);
                        $("#hidden_seld_id").text(result.data[0].seld_id);
                        //alert(result.data[0].deliver_code);
                        //document.getElementById("hid_ord_qty").value = result.data[0].ord_qty;
                        //document.location.href = "/MarketTally/MarketTallyWDProduct?number=" + number + "&upc=" + upc;
                        //alert(result.data[0].description + prod)
                        
                    }
                    else
                    {
                        $('#MessageContentId').text("當前工作代號中沒有該產品條碼!");
                        $('.MarketTally-modal-alert').modal('toggle');
                        $('#modal - dialog - close').focus();
                        $('.MarketTally-modal-alert').on('hidden.bs.modal', function (e)
                        {
                            document.location.href = "/MarketTally/MarketTally";
                        })

                    }
                }

            }).error(function ()
            {
                $('#MessageContentId').text("查詢失敗!");
                $('.MarketTally-modal-alert').modal('toggle')
                $('#modal - dialog - close').focus();
            });
            $('#stock_table').attr("data-url", "/MarketTally/GetStockByUpc?upc_id="+'@ViewBag.upc');
            $('#stock_table').bootstrapTable();
        }

        $('#delivercode').on('input', function (e)
        {
            
            if ($("#delivercode").val() == "")
            {
                $('#delivercode_group').attr("class", "input-group "); 
                $('#inputGroupStatus_delivercode').attr("class", "glyphicon");

                $('#amsure').attr("class", "btn btn-default btn-lg disabled");
                return false;
            }
            else if ($("#delivercode").val().trim() == $("#hidden_deliver_code").text().trim())
            {
                $('#delivercode_group').attr("class", "input-group has-success ");
                $('#inputGroupStatus_delivercode').attr("class", "glyphicon glyphicon-ok form-control-feedback");

                $('#amsure').attr("class", "btn btn-success btn-lg ");
                
            }
            else
            {
                $('#delivercode_group').attr("class", "input-group has-error ");
                $('#inputGroupStatus_delivercode').attr("class", "glyphicon glyphicon-remove form-control-feedback");

                $('#amsure').attr("class", "btn btn-default btn-lg disabled");
            }
        })

        $('#amsure').on('click', function ()
        {
            //
            var arrPickRowId = new Array();
            var arrPickInfo = new Array();
            var result = eval("(" + JSON.stringify($('#stock_table').bootstrapTable('getData')) + ")");
            for (var i = 0; i < result.length; i++)
            {
                if ($('#pick_num' + i).val() != "")
                {
                    if (parseInt($('#pick_num' + i).val()) > 0)
                    {
                        arrPickRowId.push(result[i].row_id);
                        arrPickInfo.push($('#pick_num' + i).val())
                    }
                }
            }
           
            if (parseInt($('#act_pick_qty').text()) > parseInt($('#out_qty').text()))
            {
                $('#MessageContentId').text("實際撿貨量不能大於撿貨數量!");
                $('.MarketTally-modal-alert').modal('toggle')
                $('#modal - dialog - close').focus();
                return false;
            }       
            
            commodity_type = 2,//寄倉調度的編號
            seld_id = $("#hidden_seld_id").text();//aseld的流水號
            out_qty = $("#out_qty").text();//缺貨數量
            ord_qty = $("#hidden_ord_qty").text();//訂貨數量
            act_pick_qty = $("#act_pick_qty").text();//實際揀貨量
            item_id = $("#hidden_item_id").text();//商品細項編號
            ordd_id = $("#hidden_ordd_id").text();
            assg_id = '@ViewBag.number';//工作代號
            ord_id =  $("#ord_id").text();
            deliver_id = $("#delivercode").val().trim();
            //pickRowId = arrPickRowId;
            //pickInfo = arrPickInfo;traditional:true
            //alert(arrPickRowId);
            //$.get('/MarketTally/GETMarkTallyWD',
            $.ajax({
                url: "/MarketTally/GETMarkTallyWD",
                type: "POST",
                dataType: "text",
                traditional:true,
                data: {
                    commodity_type: commodity_type, seld_id: seld_id, out_qty: out_qty, ord_qty: ord_qty, act_pick_qty: act_pick_qty, item_id: item_id, ordd_id: ordd_id, assg_id: assg_id, ord_id: ord_id, deliver_id: deliver_id, pickRowId: arrPickRowId, pickInfo: arrPickInfo
                },
                success: function (data)
                {
                    var result = eval("(" + data + ")");
                    if (result.success)
                    {
                        var msg = "";
                        var fa = 0;
                        if (result.qty > 0)
                        {
                            msg = "該商品缺貨! ";
                        }
                        if (result.ord == 0)
                        {
                            if (result.can == 0)
                            {
                                msg += "該訂單可以封箱! ";
                            }
                            else
                            {
                                if (result.flag == 0)
                                {
                                    fa = 1;
                                    $('#MessageContentId').text("請移交主管處理");
                                    $('.MarketTally-modal-alert').modal('toggle');
                                    $('#modal - dialog - close').focus();
                                }
                                else
                                {
                                    $('#MessageContentId').text("請移交主管處理!");
                                    $('.MarketTally-modal-alert').modal('toggle');
                                    $('#modal - dialog - close').focus();
                                    $('.MarketTally-modal-alert').on('hidden.bs.modal', function (e)
                                    {
                                        document.location.href = "/MarketTally/MarketTallyWD?number=" + '@ViewBag.number';
                                    })
                                }
                            }
                        }
                        if (result.flag == 0 && fa == 0)
                        {
                            //不繼續往下循環
                            $('#MessageContentId').text("該項目已經走完!");
                            $('.MarketTally-modal-alert').modal('toggle');
                            $('#modal - dialog - close').focus();
                            $('.MarketTally-modal-alert').on('hidden.bs.modal', function (e)
                            {
                                document.location.href = "/MarketTally/MarketTally";
                            })
                        }
                        else if (fa == 0)
                        {   //續下一個商品。                                        
                            if (msg !== "")
                            {
                                $('#MessageContentId').text(msg);
                                $('.MarketTally-modal-alert').modal('toggle');
                                $('#modal - dialog - close').focus();
                                $('.MarketTally-modal-alert').on('hidden.bs.modal', function (e)
                                {
                                    document.location.href = "/MarketTally/MarketTallyWD?number=" + '@ViewBag.number';
                                })
                            }
                        }
                    }
                    else
                    {
                        $('#MessageContentId').text("程序運行出錯,請聯繫開發人員!");
                        $('.MarketTally-modal-alert').modal('toggle')
                        $('#modal - dialog - close').focus();
                    }

                },
                error:function ()
                {
                    $('#MessageContentId').text("系統異常,請稍后再試,如有重複出錯請聯繫管理員!");
                    $('.MarketTally-modal-alert').modal('toggle')
                    $('#modal - dialog - close').focus();
                }
            });

        });
    });
</script>